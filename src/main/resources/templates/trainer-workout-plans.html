<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Manage Workout Plans - Fitness Hub</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
<div th:replace="~{fragments-navbar :: navbar('TRAINER')}"></div>

<main class="dashboard">
    <section class="dashboard-card">
        <h2><i class="fas fa-dumbbell"></i> Manage Workout Plans</h2>
        <p>Create and manage personalized workout plans for your clients</p>
        
        <div class="actions">
            <a href="javascript:void(0);" class="btn btn-primary" onclick="showCreateForm();">
                <i class="fas fa-plus"></i> Create New Plan
            </a>
        </div>
    </section>

    <!-- Create Plan Form (Initially Hidden) -->
    <section id="create-form" class="dashboard-card" style="display: none;">
        <h3><i class="fas fa-plus"></i> Create New Workout Plan</h3>
        
        <form id="workout-plan-form">
            <div class="form-group">
                <label for="memberId"><i class="fas fa-user"></i> Select Member</label>
                <select id="memberId" required>
                    <option value="">Choose a member...</option>
                    <option th:each="member : ${members}" 
                            th:value="${member.id}" 
                            th:text="${member.user.firstName + ' ' + member.user.lastName + ' (' + member.user.email + ')'}">
                        Member Name
                    </option>
                </select>
                <small>Select the member this workout plan is for</small>
            </div>
            
            <div class="form-group">
                <label for="title"><i class="fas fa-heading"></i> Plan Title</label>
                <input type="text" id="title" required placeholder="e.g. Beginner Strength Training">
            </div>
            
            <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> Description</label>
                <textarea id="description" rows="3" placeholder="Plan overview and goals..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="difficultyLevel"><i class="fas fa-chart-line"></i> Difficulty Level</label>
                <select id="difficultyLevel">
                    <option value="BEGINNER">Beginner</option>
                    <option value="INTERMEDIATE">Intermediate</option>
                    <option value="ADVANCED">Advanced</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="durationWeeks"><i class="fas fa-calendar-week"></i> Duration (Weeks)</label>
                <input type="number" id="durationWeeks" min="1" max="52" value="4">
            </div>
            
            <h4><i class="fas fa-list"></i> Workout Items</h4>
            <div id="workout-items">
                <div class="workout-item">
                    <div class="item-row">
                        <input type="text" placeholder="Exercise name" class="exercise-name" required>
                        <select class="day-of-week">
                            <option value="MONDAY">Monday</option>
                            <option value="TUESDAY">Tuesday</option>
                            <option value="WEDNESDAY">Wednesday</option>
                            <option value="THURSDAY">Thursday</option>
                            <option value="FRIDAY">Friday</option>
                            <option value="SATURDAY">Saturday</option>
                            <option value="SUNDAY">Sunday</option>
                        </select>
                        <input type="number" placeholder="Sets" class="sets" min="1" required>
                        <input type="text" placeholder="Reps" class="reps" required>
                        <button type="button" onclick="removeItem(this)" class="btn-danger-small">Ã—</button>
                    </div>
                </div>
            </div>
            
            <button type="button" onclick="addWorkoutItem()" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Exercise
            </button>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Create Plan
                </button>
                <button type="button" onclick="hideCreateForm()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </section>

    <!-- Existing Plans -->
    <section class="dashboard-card">
        <h3><i class="fas fa-list"></i> My Workout Plans</h3>
        
        <div id="plans-list">
            <div th:if="${workoutPlans.empty}" class="empty-state">
                <div class="empty-state-icon">ðŸ’ª</div>
                <div class="empty-state-text">No workout plans yet</div>
                <p>Create your first workout plan to get started!</p>
            </div>
            
            <div th:unless="${workoutPlans.empty}" class="plans-grid">
                <div th:each="plan : ${workoutPlans}" class="plan-card">
                    <div class="plan-header">
                        <h4 th:text="${plan.title}">Plan Title</h4>
                        <span class="plan-date" th:text="${#temporals.format(plan.createdAt, 'MMM dd, yyyy')}">Date</span>
                    </div>
                    <div class="plan-info">
                        <p><i class="fas fa-user"></i> <strong>Member:</strong> <span th:text="${plan.member.user.username}">Member Name</span></p>
                        <p th:if="${plan.description}" th:text="${plan.description}">Description</p>
                        <p th:if="${plan.difficultyLevel}"><i class="fas fa-chart-line"></i> <strong>Level:</strong> <span th:text="${plan.difficultyLevel}">Beginner</span></p>
                        <p th:if="${plan.durationWeeks}"><i class="fas fa-calendar-week"></i> <strong>Duration:</strong> <span th:text="${plan.durationWeeks + ' weeks'}">4 weeks</span></p>
                    </div>
                    <div class="plan-actions">
                        <a th:href="@{/workout-plans/{id}(id=${plan.id})}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                        <button th:onclick="'deletePlan(' + ${plan.id} + ')'" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
function showCreateForm() {
    document.getElementById('create-form').style.display = 'block';
    document.getElementById('create-form').scrollIntoView({ behavior: 'smooth' });
}

function hideCreateForm() {
    document.getElementById('create-form').style.display = 'none';
    document.getElementById('workout-plan-form').reset();
    // Reset to one workout item
    const container = document.getElementById('workout-items');
    container.innerHTML = `
        <div class="workout-item">
            <div class="item-row">
                <input type="text" placeholder="Exercise name" class="exercise-name" required>
                <select class="day-of-week">
                    <option value="MONDAY">Monday</option>
                    <option value="TUESDAY">Tuesday</option>
                    <option value="WEDNESDAY">Wednesday</option>
                    <option value="THURSDAY">Thursday</option>
                    <option value="FRIDAY">Friday</option>
                    <option value="SATURDAY">Saturday</option>
                    <option value="SUNDAY">Sunday</option>
                </select>
                <input type="number" placeholder="Sets" class="sets" min="1" required>
                <input type="text" placeholder="Reps" class="reps" required>
                <button type="button" onclick="removeItem(this)" class="btn-danger-small">Ã—</button>
            </div>
        </div>
    `;
}

function addWorkoutItem() {
    const container = document.getElementById('workout-items');
    const newItem = document.createElement('div');
    newItem.className = 'workout-item';
    newItem.innerHTML = `
        <div class="item-row">
            <input type="text" placeholder="Exercise name" class="exercise-name" required>
            <select class="day-of-week">
                <option value="MONDAY">Monday</option>
                <option value="TUESDAY">Tuesday</option>
                <option value="WEDNESDAY">Wednesday</option>
                <option value="THURSDAY">Thursday</option>
                <option value="FRIDAY">Friday</option>
                <option value="SATURDAY">Saturday</option>
                <option value="SUNDAY">Sunday</option>
            </select>
            <input type="number" placeholder="Sets" class="sets" min="1" required>
            <input type="text" placeholder="Reps" class="reps" required>
            <button type="button" onclick="removeItem(this)" class="btn-danger-small">Ã—</button>
        </div>
    `;
    container.appendChild(newItem);
}

function removeItem(button) {
    const container = document.getElementById('workout-items');
    if (container.children.length > 1) {
        button.closest('.workout-item').remove();
    }
}

document.getElementById('workout-plan-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Collect form data
    const formData = {
        memberId: parseInt(document.getElementById('memberId').value),
        trainerId: /*[[${trainerId}]]*/ 1,
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        difficultyLevel: document.getElementById('difficultyLevel').value,
        durationWeeks: parseInt(document.getElementById('durationWeeks').value),
        items: []
    };
    
    // Collect workout items
    const items = document.querySelectorAll('.workout-item');
    items.forEach(item => {
        const exerciseName = item.querySelector('.exercise-name').value;
        const dayOfWeek = item.querySelector('.day-of-week').value;
        const sets = parseInt(item.querySelector('.sets').value);
        const reps = item.querySelector('.reps').value;
        
        if (exerciseName && sets && reps) {
            formData.items.push({
                exerciseName,
                dayOfWeek,
                sets,
                reps
            });
        }
    });
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    
    try {
        const headers = {
            'Content-Type': 'application/json',
        };
        
        // Add CSRF token if available
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/api/workout-plans', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            alert('Workout plan created successfully!');
            hideCreateForm();
            window.location.reload(); // Refresh to show new plan
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            alert('Error creating workout plan: ' + (errorText || 'Please try again.'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating workout plan: ' + error.message);
    }
});

function editPlan(planId) {
    // TODO: Implement edit functionality
    alert('Edit functionality coming soon!');
}

async function deletePlan(planId) {
    if (!confirm('Are you sure you want to delete this workout plan? This action cannot be undone.')) {
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    
    try {
        const headers = {};
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch(`/api/workout-plans/${planId}`, {
            method: 'DELETE',
            headers: headers
        });
        
        if (response.ok) {
            alert('Workout plan deleted successfully!');
            window.location.reload();
        } else {
            alert('Error deleting workout plan. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting workout plan: ' + error.message);
    }
}

// Load plans on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Trainer workout plans page loaded');
    const memberSelect = document.getElementById('memberId');
    console.log('Member options count:', memberSelect.options.length - 1); // -1 for the placeholder
});
</script>

<style>
.actions {
    margin-top: 1rem;
}

.actions .btn {
    display: inline-block;
    text-decoration: none;
    cursor: pointer;
    z-index: 10;
    position: relative;
}

.workout-item {
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 8px;
    border: 1px solid rgba(79, 209, 197, 0.2);
}

.item-row {
    display: grid;
    grid-template-columns: 2fr 1fr 80px 100px 40px;
    gap: 0.5rem;
    align-items: center;
}

.btn-danger-small {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-danger-small:hover {
    background: #dc2626;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(79, 209, 197, 0.2);
}

@media (max-width: 768px) {
    .item-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
}

.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.plan-card {
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid rgba(79, 209, 197, 0.3);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.plan-card:hover {
    border-color: #4fd1c5;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(79, 209, 197, 0.2);
}

.plan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(79, 209, 197, 0.2);
}

.plan-header h4 {
    color: #4fd1c5;
    margin: 0;
}

.plan-date {
    color: #94a3b8;
    font-size: 0.875rem;
}

.plan-info p {
    margin: 0.5rem 0;
    color: #e2e8f0;
}

.plan-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(79, 209, 197, 0.2);
}

.plan-actions .btn {
    flex: 1;
    text-align: center;
}

.btn-danger {
    background: #ef4444;
    color: white;
    border: 1px solid #dc2626;
}

.btn-danger:hover {
    background: #dc2626;
    border-color: #b91c1c;
}
</style>
</body>
</html>